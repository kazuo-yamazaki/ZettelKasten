#exapilot
# 工程部品の実行の仕組み
工程ユニットの中の工程部品は、一定のルールに則り一列に並べられる。たとえ、並列実行の部品があっても、内部的には一列に配置され、実際に並列で動作することはない。この順序が工程ユニット内の工程部品実行順序になる。

実行周期毎に、最初の工程部品から、最後の工程部品まで順番に実行される。
繰り返し線がある場合、順方向に進む場合は通常の流れと同様だが、逆方向に流れる場合は、流れ線の先にある工程部品はすぐに実行されずに、次の実行周期で実行される。これは実装による制約と思われる。

工程部品の実行の前に、OPCからデータが読み込まれる。

工程部品は[[202107151445 工程部品の状態|状態]]とモードを持ち、かつコマンドを受け取る。この状態、モード、受け取っているコマンドによって実行内容が異なる。多くの工程部品は、初期状態、通常終了状態、手動終了状態、一時停止状態、待機状態、待機中一時停止状態に遷移すると、工程部品の実行を終了し、次の工程部品の実行が始まる。ただしタイマー部品のような一部の工程部品は、実行状態の中で、工程部品の実行が終了する。


実行周期中に工程ユニット内のすべての工程部品の実行が終了しなければならない。もし終了できない場合は、ログが残される。


工程ユニット中の工程ユニットは見た目は工程部品だが、通常の工程部品とは異なる動作をする。

ネストされた工程ユニットは、親の工程ユニットとは別のスレッドで動作している。それぞれが実行周期をもち、まったく別の周期で動作することもある。そのため、親の工程ユニットから、子供の工程ユニットに実行コマンドを送るための仕組みが必要になる。

親の工程ユニットは、実行コマンドを子供の工程ユニットに渡されると、0.1秒後に子供の工程ユニットの先頭の工程部品に実行コマンドを送る。これにより子供の工程ユニットは次の実行周期が来ると先頭の工程部品から実行を行うことができる。

子供の工程ユニットのすべての工程部品が実行されると、親ユニットにイベントが送られる。親ユニットはこのイベントを受け取ると、実行周期を待たずに、実行処理を開始する。すなわち親ユニットの最初の工程部品から最後の工程部品に向けて実行処理が走る。子供の工程ユニットを示す工程ユニット部品が次の工程部品へ実行コマンドを送ることで、処理が継続される。

工程モジュールは工程ユニットと同じ仕組みであるが、親ユニット同じスレッドの中で動作する。これは、工程ユニットが別のスレッドで動作するようにしているため、スレッド数が多くなることを懸念して、このような仕様となっている。
スレッドプールの概念がなかった時代の設計であるため。
ただし制約があり、工程モジュール内で工程ユニットを使うことができない。

# Prev
[[202107140957 業務フロー]]




